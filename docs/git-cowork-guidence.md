# Git å”ä½œæŒ‡å—ï¼šåŸºæ–¼ Pull Request (PR) æµç¨‹

æœ¬å°ˆæ¡ˆæ¡ç”¨ **Feature Branching + å¼·åˆ¶ CI/CD æª¢æŸ¥** çš„é–‹ç™¼æ¨¡å¼ã€‚`main` åˆ†æ”¯æ˜¯ç¥è–çš„ (Sacred)ï¼Œå®ƒå¿…é ˆå§‹çµ‚è™•æ–¼å¯ç·¨è­¯ã€å¯é‹è¡Œçš„ç‹€æ…‹ã€‚æ‰€æœ‰ç¨‹å¼ç¢¼è®Šæ›´éƒ½å¿…é ˆé€é Pull Request (PR) æ‰èƒ½åˆä½µã€‚

---

## I. æ¨™æº–é–‹ç™¼æµç¨‹ (Standard Workflow)

### Step 1: ç¢ºä¿ä¸»ç·š (main) ç‚ºæœ€æ–°ä¸¦å»ºç«‹åˆ†æ”¯

åœ¨é–‹å§‹ä»»ä½•é–‹ç™¼å·¥ä½œä¹‹å‰ï¼Œè«‹å…ˆç¢ºä¿ä½ çš„æœ¬åœ° `main` åˆ†æ”¯æ˜¯æœ€æ–°çš„ã€‚

```bash
# 1. åˆ‡æ›å› main åˆ†æ”¯
git switch main

# 2. æ‹‰å–é ç«¯æœ€æ–°ç¨‹å¼ç¢¼
git pull origin main

# 3. å»ºç«‹ä½ çš„åŠŸèƒ½åˆ†æ”¯
# å‘½åè¦ç¯„ï¼šfeature/<ä½ çš„ä»»å‹™ç°¡ç¨±>ï¼Œä¾‹å¦‚ï¼šfeature/mq-init, feature/atomic-transfer
git switch -c feature/your-task-name
```

### Step 2: é–‹ç™¼ã€æäº¤ (Commit) èˆ‡æ¨é€

åœ¨ä½ è‡ªå·±çš„ Feature Branch ä¸Šé€²è¡Œç¨‹å¼ç¢¼æ’°å¯«ã€‚

```bash
# 1. æ’°å¯«ä½ çš„ç¨‹å¼ç¢¼ (ä¾‹å¦‚ï¼šåœ¨ src/common/mq_wrapper.c å¯¦ä½œ)

# 2. ç·¨è­¯èˆ‡æ¸¬è©¦ (æœ¬åœ°é©—è­‰æ˜¯ç¾©å‹™)
# åœ¨æ ¹ç›®éŒ„åŸ·è¡Œï¼š
mkdir build
cd build
cmake ..
make
./bin/test_bank  # åŸ·è¡Œä½ è² è²¬æ¨¡çµ„çš„å–®å…ƒæ¸¬è©¦

# 3. åŠ å…¥è®Šå‹•ä¸¦æäº¤
git add .
# æäº¤è¨Šæ¯è¦ç¯„ï¼š<é¡å‹>: [æ¨¡çµ„] æè¿°
# é¡å‹ï¼šfeat (æ–°åŠŸèƒ½), fix (ä¿® Bug), docs (æ–‡ä»¶)
git commit -m "feat: [MQ] Implement logger_mq_init and cleanup"

# 4. æ¨é€åˆ°é ç«¯
# é¦–æ¬¡æ¨é€éœ€è¨­å®š upstream
git push -u origin feature/your-task-name
```

### Step 3: æäº¤ PR å‰çš„é—œéµå‹•ä½œï¼šèˆ‡ä¸»ç·šåŒæ­¥ (CRITICAL)

åœ¨ä½ ç™¼é€ PR ä¹‹å‰ï¼Œå¿…é ˆå…ˆå°‡æœ€æ–°çš„ `main` ç¨‹å¼ç¢¼åˆä½µåˆ°ä½ çš„åˆ†æ”¯ä¸¦è§£æ±ºæ‰€æœ‰è¡çªã€‚é€™æ˜¯ç¢ºä¿æ•´åˆæ¸¬è©¦ (Integration Test) æˆåŠŸçš„é—œéµã€‚

```bash
# 1. åˆ‡æ›å› main åˆ†æ”¯
git switch main
git pull origin main  # ç¢ºä¿ main æ˜¯æœ€æ–°çš„

# 2. åˆ‡æ›å›ä½ çš„åŠŸèƒ½åˆ†æ”¯
git switch feature/your-task-name

# 3. å°‡æœ€æ–°çš„ main åˆä½µé€²ä¾†
git merge main 
# å¦‚æœå‡ºç¾ CONFLICT (è¡çª)ï¼Œè«‹ç«‹å³é€²å…¥ Step 4 è§£æ±ºã€‚
```

### Step 4: ç™¼é€ Pull Request (PR)

åœ¨ Step 3 å®Œæˆå¾Œï¼Œå†æ¬¡ `git push` ä¸Šå‚³ä½ çš„æœ¬åœ°è®Šæ›´å’Œè¡çªè§£æ±ºçµæœã€‚æ‰“é–‹ GitHub é é¢ï¼Œç³»çµ±æœƒæç¤ºä½ å»ºç«‹ PRã€‚

**PR æ¨™é¡Œï¼š** ä½¿ç”¨èˆ‡ Commit ç›¸åŒçš„è¦ç¯„ (ä¾‹å¦‚ï¼š`feat: [Bank Core] å¯¦ä½œ bank_transfer äº¤æ˜“é–`)

**PR å…§å®¹ï¼š** è©³ç´°èªªæ˜ä½ åšäº†å“ªäº›ä¿®æ”¹ã€æ¸¬è©¦çµæœï¼Œä»¥åŠæ˜¯å¦æœ‰ä»»ä½•éœ€è¦ Orchestrator (æ¶æ§‹å¸«) å¯©æ ¸çš„ä»‹é¢è®Šå‹•ã€‚

**åˆä½µæ¢ä»¶ï¼š**
- ç­‰å¾… GitHub Actions (CI) é‹è¡Œç‹€æ…‹æª¢æŸ¥
- åªæœ‰åœ¨ CI ç¶ ç‡ˆ (âœ…) ä¸”è‡³å°‘ä¸€ä½çµ„å“¡ (Code Owner) æ ¸å‡†å¾Œï¼ŒPR æ‰èƒ½è¢«åˆä½µ

---

## II. å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ (Troubleshooting)

### ç¨‹å¼ç¢¼è¡çª (Merge Conflict)

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| `CONFLICT (content): Merge conflict in...` | 1. æ‰‹å‹•ç·¨è¼¯è¡çªæª”æ¡ˆ (æ‰¾ `<<<<<<<`, `>>>>>>>` ç¬¦è™Ÿ)<br>2. ç§»é™¤è¡çªæ¨™è¨˜ä¸¦ä¿ç•™æ­£ç¢ºç¨‹å¼ç¢¼<br>3. `git add .`<br>4. `git commit` (ä¿ç•™ Git é è¨­çš„ Merge Message) | è¡çªå¿…é ˆåœ¨æœ¬åœ°è§£æ±ºã€‚ä¸è¦æŠŠè¡çªä¸Ÿçµ¦ PR è®“å…¶ä»–äººå¹«ä½ è§£ |

### CI ç‹€æ…‹æª¢æŸ¥å¤±æ•—

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| PR é¡¯ç¤º `build-and-test` ç´…å‰å‰ (âŒ) | 1. é»æ“Šç´…å‰å‰æŸ¥çœ‹ Log æ‰¾å‡ºéŒ¯èª¤åŸå› <br>2. åœ¨æœ¬åœ°ä¿®å¾©ç¨‹å¼ç¢¼<br>3. `git commit --amend` (ä¿®æ”¹ä¸Šä¸€å€‹æäº¤) æˆ– `git commit -m "fix: CI fail"`<br>4. `git push` | CI å¤±æ•—é€šå¸¸æ˜¯ç·¨è­¯éŒ¯èª¤æˆ– Unit Test æ²’éã€‚ç´…ç‡ˆä¸èƒ½ Mergeï¼Œè«‹ä¿®å¾©å¾Œé‡æ–° Push |

### åˆ†æ”¯éæ™‚ (Out of Date)

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| PR é¡¯ç¤º `This branch is out-of-date with the base branch` | åŸ·è¡Œ Step 3 çš„åŒæ­¥æµç¨‹ï¼š<br>`git switch main`<br>`git pull origin main`<br>`git switch feature/your-task-name`<br>`git merge main` | é€™æ˜¯å› ç‚ºåœ¨ä½ é–‹ç™¼æœŸé–“ï¼Œå…¶ä»–äººçš„ç¨‹å¼ç¢¼å·²ç¶“åˆä½µåˆ° `main` äº†ã€‚ä½ éœ€è¦å°‡é€™äº›æ–°è®Šæ›´æ‹‰é€²ä¾†ï¼Œä¸¦è­‰æ˜ä½ çš„ç¨‹å¼ç¢¼èˆ‡å®ƒå€‘æ•´åˆå¾Œä»ç„¶èƒ½é‹è¡Œ |

### ç„¡æ³• Push åˆ° Main

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| `remote rejected: main -> main (protected branch hook failed)` | é€™æ˜¯é æœŸçš„çµæœã€‚`main` åˆ†æ”¯è¢«ä¿è­·ã€‚è«‹ç¢ºèªä½ æ˜¯åœ¨ `feature/` åˆ†æ”¯ä¸Šå·¥ä½œï¼Œä¸¦ç™¼é€ Pull Requestã€‚é™¤éç·Šæ€¥ç‹€æ³ä¸¦ç²å¾— Orchestrator è¨±å¯ï¼Œå¦å‰‡ç¦æ­¢ç›´æ¥ Push åˆ° `main` | Branch protection æ˜¯ç‚ºäº†ä¿è­· `main` çš„ç©©å®šæ€§ |

### PR Merge æŒ‰éˆ•è¢«ç¦ç”¨

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| æŒ‰éˆ•ç‚ºç°è‰²ï¼Œæç¤º `Required approval missing` æˆ– `Status checks failed` | 1. æª¢æŸ¥ CI æ˜¯å¦ç‚ºç¶ ç‡ˆ (âœ…)<br>2. è¯ç¹« Orchestrator æˆ–ä½ çš„ Code Owner é€²è¡Œ Review å’Œ Approve | å¿…é ˆæ»¿è¶³ã€Œ1 å€‹æ ¸å‡†ã€å’Œã€ŒCI é€šéã€å…©å€‹æ¢ä»¶æ‰èƒ½åˆä½µ |

### éŒ¯èª¤ï¼šåœ¨ main ä¸Š Commit ä¸¦ Push å¤±æ•—

| éŒ¯èª¤æç¤º | è§£æ±ºæ–¹æ¡ˆ | åŸç†è§£é‡‹ |
|---------|---------|---------|
| `remote rejected: main -> main (protected branch hook declined)` ä¸”æœ¬åœ° `main` ä¸Šæœ‰æ–°çš„ Commit | è«‹åƒé–± **III. ç·Šæ€¥ä¿®å¾©ï¼šæ¶æ•‘ Commit** | é€™æ˜¯æœ€å¸¸è¦‹çš„éŒ¯èª¤ã€‚ä½ éœ€è¦å°‡ Commit è½‰ç§»åˆ°æ–°åˆ†æ”¯ï¼Œç„¶å¾Œæ¸…ç†æœ¬åœ° `main` |

---

## III. ç·Šæ€¥ä¿®å¾©ï¼šæ¶æ•‘ Commit (Preserve and Move)

å¦‚æœä½ ä¸å°å¿ƒåœ¨æœ¬åœ° `main` åˆ†æ”¯ä¸Šé€²è¡Œäº† Commitï¼Œç„¶å¾Œ Push è¢«é ç«¯æ‹’çµ•ï¼Œè«‹ä¸è¦æ“”å¿ƒï¼Œ**ä½ çš„å·¥ä½œæ²’æœ‰ä¸Ÿå¤±**ã€‚

é€™æ˜¯ä¿®å¾©æ­¤éŒ¯èª¤çš„æ¨™æº–æµç¨‹ï¼Œå®ƒæœƒåœ¨ä¸ä¸Ÿæ£„æˆæœçš„å‰æä¸‹ï¼Œå°‡ Commit è½‰ç§»åˆ°æ­£ç¢ºçš„ Feature Branch ä¸Šã€‚

### Phase 1: è½‰ç§»æˆæœåˆ°æ–°åˆ†æ”¯

é€™å€‹æ­¥é©Ÿçš„ç›®çš„æ˜¯åœ¨ä¸ä¸Ÿå¤± Commit çš„æƒ…æ³ä¸‹ï¼Œå°‡å®ƒå®‰å…¨åœ°å¾ `main` ä¸Šã€Œè¤‡è£½ã€åˆ°ä¸€å€‹æ–°åˆ†æ”¯ã€‚

```bash
# å‡è¨­ä½ çš„ commit message æ˜¯ "add git cowork guidence"
# 1. ç¢ºèªä½ åœç•™åœ¨æœ¬åœ° main åˆ†æ”¯
git switch main 

# 2. ğŸŒŸ é—œéµæ­¥é©Ÿï¼šåŸºæ–¼ç•¶å‰ç‹€æ…‹ï¼ˆå«éŒ¯èª¤ commitï¼‰å»ºç«‹æ–°åˆ†æ”¯
# é€™æœƒå°‡ä½ çš„ commit å®‰å…¨åœ°åŒ…å«åœ¨æ–°åˆ†æ”¯ä¸­
git switch -c feature/fix-git-commit

# è¼¸å‡ºæ‡‰é¡¯ç¤ºï¼šSwitched to a new branch 'feature/fix-git-commit'
```

### Phase 2: æ¸…ç†æœ¬åœ° main åˆ†æ”¯

ç¾åœ¨ä½ çš„æˆæœå·²ç¶“åœ¨æ–°åˆ†æ”¯ (`feature/fix-git-commit`) ä¸Šäº†ï¼Œæˆ‘å€‘å¯ä»¥å®‰å…¨åœ°æ¸…ç†æœ¬åœ°çš„ `main`ã€‚

```bash
# 1. åˆ‡æ›å› main åˆ†æ”¯
git switch main

# 2. ğŸŒŸ é—œéµæ­¥é©Ÿï¼šå¼·åˆ¶å°‡æœ¬åœ° main å›æº¯åˆ°é ç«¯ main çš„æœ€æ–°ç‹€æ…‹
# é€™æœƒç§»é™¤æœ¬åœ°å¤šé¤˜çš„ commitï¼Œè®“ main ä¿æŒä¹¾æ·¨
git reset --hard origin/main

# è¼¸å‡ºæ‡‰é¡¯ç¤ºï¼šHEAD is now at [é ç«¯æœ€æ–°çš„ Commit ID] [é ç«¯æœ€æ–°çš„ Commit Message]
```

### Phase 3: ç¹¼çºŒæ­£ç¢ºçš„ PR æµç¨‹

ç¾åœ¨ä½ çš„æœ¬åœ° `main` å·²ç¶“ä¹¾æ·¨äº†ï¼Œä½ çš„æˆæœåœ¨æ–°åˆ†æ”¯ä¸Šï¼Œå¯ä»¥ç¹¼çºŒç™¼ PR äº†ã€‚

```bash
# 1. åˆ‡æ›å›ä½ çš„åŠŸèƒ½åˆ†æ”¯
git switch feature/fix-git-commit

# 2. å°‡æˆæœæ¨é€åˆ°é ç«¯
git push -u origin feature/fix-git-commit

# 3. è¨ªå• GitHubï¼Œç™¼é€ Pull Request åˆ° main åˆ†æ”¯
```

---

## IV. æ ¸å¿ƒåŸå‰‡ (Key Principles)

> **ã€Œè§£æ±ºè¡çªæœ€å¥½çš„æ–¹æ³•ï¼Œå°±æ˜¯é¿å…è¡çªã€‚ã€**

å‹™å¿…åœ¨ç™¼ PR å‰ï¼Œå…ˆåŸ·è¡Œ `git pull origin main`ï¼Œç¢ºä¿ä½ åœ¨æœ¬åœ°ç«¯è™•ç†æ‰€æœ‰å•é¡Œã€‚

**Checklist åœ¨ç™¼é€ PR å‰ï¼š**

- âœ… å·²åŸ·è¡Œ `git merge main` ä¸¦è§£æ±ºæ‰€æœ‰è¡çª
- âœ… æœ¬åœ°ç·¨è­¯é€šé (`make` ç„¡éŒ¯èª¤)
- âœ… å–®å…ƒæ¸¬è©¦é€šé (`./bin/test_bank`)
- âœ… Commit è¨Šæ¯ç¬¦åˆè¦ç¯„ (`feat/fix/docs: [æ¨¡çµ„] æè¿°`)
- âœ… PR æ¨™é¡Œæ¸…æ™°ï¼Œå…§å®¹è©³ç´°
- âœ… æ²’æœ‰ Push åˆ° `main` åˆ†æ”¯